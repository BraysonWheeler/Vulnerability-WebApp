const express = require('express')
const router = express.Router()
const db = require('./database')
const bcrypt = require('bcrypt')


router.get('/', (request, response) => {
    response.render('index')
})

router.post('/submit', async (request, response) => {
    db.query(`select password from users where username=\'${request.body.username}\'`, async (err, result) => {
        if(err) {
            console.error(err)
        }
        else {
            if (result.rowCount > 0){
                if (await bcrypt.compare(request.body.password, result.rows[0].password)){
                    console.log('success')
                    response.redirect('/home')
                    return
                }
                else {
                    response.redirect('/')
                    console.log('No')
                }
            }
            else {
                response.redirect('/')
                console.log('invalid')
            }
        }
    })
})

router.get('/account/create', async (request, response) => {
    response.render('create')
})

router.get('/home' , async(request, response) => {
    db.query(`select * from vulns`, async(err, result) => {
        if(err){
            console.error(err)
        }
        else{
            rows = result.rows
            response.render('home', {rows})
        }
    })
})

router.post('/account/create/submit', async (request, response) => {
    try{
        const salt = await bcrypt.genSalt()
        const hashedPassword = await bcrypt.hash(request.body.password, salt)
        const createAccountQuery = 
        `
            INSERT INTO users (username, password)
            VALUES ($1, $2)
        `
        data = [request.body.username, hashedPassword]
        db_resp = db.query(createAccountQuery, data, (err, result) => {
            if(err) {
                console.error(err)
            }
            else {
                console.log('created')
            }
        })
        response.status(200)
        response.redirect('/')
    }
    catch(err) {
        console.log(err)
        response.status(200)
    }

})

module.exports = router

