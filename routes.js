const express = require('express')
const router = express.Router()
const db = require('./database')
const bcrypt = require('bcrypt')


router.get('/', (request, response) => {
    response.render('pages/index')
})

router.post('/submit', async (request, response) => {
    db_resp =  db.query(`select count(*) from users where username=\'${request.body.username}\' and password=\'${request.body.password}\'`, (err, result) => {
        if(err) {
            console.error(err)
        }
        else {
            count = result.rows[0].count
            if (count === '0'){
                console.log('invalid')
            }
            else{
                console.log('valid')
            }
        }
    })
    console.log(db_resp)
    response.redirect('/')
})

router.get('/account/create', async (request, response) => {
    response.render('pages/create')
})

router.post('/account/create/submit', async (request, response) => {
    try{
        const salt = await bcrypt.genSalt()
        const hashedPassword = await bcrypt.hash(request.body.password, salt)
        const createAccountQuery = 
        `
            INSERT INTO users (username, password)
            VALUES ($1, $2)
        `
        data = [request.body.username, hashedPassword]
        db_resp = db.query(createAccountQuery, data, (err, result) => {
            if(err) {
                console.error(err)
            }
            else {
                console.log('created')
            }
        })
        response.status(200)
    }
    catch(err) {
        console.log(err)
        response.status(200)
    }

})

module.exports = router

