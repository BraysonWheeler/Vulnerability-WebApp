// loads db with data from nvd api

const { default: axios } = require("axios");
const { Client } = require('pg')
const url = 'https://services.nvd.nist.gov/rest/json/cves/2.0'
const insertQuery = 
`
    INSERT INTO vulns (id, published, last_modified, vuln_status)
    VALUES ($1, $2, $3, $4)
`


async function getVulns(){
    const response = await axios.get(url)
    const vulns = response.data['vulnerabilities'].slice(0,10)
    return vulns
}

async function psqlInsert(vulns){
    const client = new Client({
        host:'localhost',
        port: 5432,
        database: 'vulndb',
        user: 'postgres',
        password: ''
    })
    client
        .connect()
        .then(() => console.log('connected'))
        .catch((err) => console.error('con error', err.stack))
    
    for(i = 0; i < vulns.length; i++){
        inner = vulns[i]['cve']
        id = inner['id']
        published = inner['published']
        lastModified = inner['lastModified']
        vulnStatus = inner['vulnStatus']

        data = [id, published, lastModified, vulnStatus]
        res = await client.query(insertQuery, data)
    }
    await client.end()
}

async function run(){
    try{
        vulns = await getVulns()
        psqlInsert(vulns)
    }
    catch(err){
        console.log(err)
    }
}

run()
